<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta 
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <meta name="screen-orientation" content="landscape" />
  <title>KiPi Runner</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      touch-action: manipulation;
    }
    
    body {
      margin: 0;
      overflow: hidden;
      background: #1a1a2e;
      color: white;
      -webkit-tap-highlight-color: transparent;
    }

    canvas {
      display: block;
      touch-action: none;
    }

    .overlay {
      position: absolute;
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      text-align: center;
      padding: 20px;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    .overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .title {
      font-size: 3.5rem;
      margin-bottom: 20px;
      color: #0fcc45;
      text-shadow: 0 0 10px rgba(15, 204, 69, 0.7);
      letter-spacing: 2px;
    }

    .subtitle {
      font-size: 1.5rem;
      margin-bottom: 40px;
      color: #e6e6e6;
      max-width: 500px;
    }

    .instructions {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      max-width: 500px;
      text-align: left;
    }

    .instructions h3 {
      color: #4ecca3;
      margin-bottom: 15px;
      font-size: 1.4rem;
    }

    .instructions ul {
      list-style-type: none;
      padding-left: 20px;
    }

    .instructions li {
      margin: 12px 0;
      display: flex;
      align-items: flex-start;
    }

    .instructions li::before {
      content: "•";
      color: #0fcc45;
      font-weight: bold;
      display: inline-block;
      width: 20px;
      font-size: 1.5rem;
    }

    .start-btn {
      background: linear-gradient(to right, #0fcc45, #4ecca3);
      color: white;
      border: none;
      padding: 15px 50px;
      font-size: 1.4rem;
      border-radius: 50px;
      cursor: pointer;
      margin-top: 20px;
      box-shadow: 0 5px 15px rgba(15, 204, 69, 0.4);
      transition: all 0.3s ease;
      font-weight: bold;
    }

    .start-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(15, 204, 69, 0.6);
    }

    #rotateNotice {
      position: absolute;
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      background: linear-gradient(135deg, #16213e, #0f3460);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      z-index: 20;
      font-size: calc(16px + 2vw);
      line-height: 1.5;
    }

    .rotate-icon {
      font-size: 5rem;
      margin-bottom: 30px;
      animation: rotate 2s infinite linear;
      color: #0fcc45;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(90deg); }
    }

    .game-stats {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 5;
      pointer-events: none;
    }

    .stat {
      font-size: 1.2rem;
      margin-bottom: 10px;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 15px;
      border-radius: 10px;
      display: inline-block;
    }

    .credit {
      position: absolute;
      bottom: 20px;
      right: 20px;
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.7);
      background: rgba(0, 0, 0, 0.3);
      padding: 5px 10px;
      border-radius: 5px;
      pointer-events: none;
    }

    .controls {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 5;
    }

    .control-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: 3px solid rgba(255, 255, 255, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: white;
      cursor: pointer;
      user-select: none;
    }

    .jump-btn {
      background: rgba(15, 204, 69, 0.3);
    }

    .volume-control {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 5;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px 10px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .volume-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: white;
      cursor: pointer;
    }

    .touch-notice {
      position: absolute;
      bottom: 100px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.7);
      pointer-events: none;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }

    @media (max-width: 768px) {
      .title {
        font-size: 2.5rem;
      }
      
      .subtitle {
        font-size: 1.2rem;
      }
      
      .start-btn {
        padding: 12px 40px;
        font-size: 1.2rem;
      }
      
      .instructions {
        padding: 15px;
      }
      
      .control-btn {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
      }
      
      .touch-notice {
        font-size: 1rem;
        bottom: 80px;
      }
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <audio id="bgMusic" loop preload="auto">
    <source src="engine.mp3" type="audio/mpeg">
  </audio>

  <div class="overlay" id="startOverlay">
    <h1 class="title">KiPi Runner</h1>
    <p class="subtitle">Run, jump, and survive as long as you can!</p>
    
    <div class="instructions">
      <h3>How to Play</h3>
      <ul>
        <li><strong>Tap anywhere on the screen</strong> to jump over obstacles</li>
        <li>Avoid hitting obstacles to survive</li>
        <li>Game speed increases over time</li>
        <li>Longer survival = higher score!</li>
      </ul>
    </div>
    
    <button class="start-btn" onclick="startGame()">START GAME</button>
  </div>

  <div id="rotateNotice">
    <div class="rotate-icon">↻</div>
    <p>Please rotate your device to landscape mode</p>
    <p>Then tap to continue</p>
  </div>

  <div class="game-stats">
    <div class="stat" id="scoreDisplay">Score: 0</div>
    <div class="stat" id="speedDisplay">Speed: 1.00</div>
  </div>

  <div class="volume-control">
    <div class="volume-btn" id="volDown">-</div>
    <div class="volume-btn" id="volUp">+</div>
  </div>

  <div class="touch-notice" id="touchNotice">Tap anywhere to jump!</div>
  
  <div class="credit">Developed by Toha</div>
  
  <div class="controls">
    <div class="control-btn jump-btn" id="jumpBtn">↑</div>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startOverlay = document.getElementById("startOverlay");
    const rotateNotice = document.getElementById("rotateNotice");
    const scoreDisplay = document.getElementById("scoreDisplay");
    const speedDisplay = document.getElementById("speedDisplay");
    const jumpBtn = document.getElementById("jumpBtn");
    const volDownBtn = document.getElementById("volDown");
    const volUpBtn = document.getElementById("volUp");
    const bgMusic = document.getElementById("bgMusic");
    const touchNotice = document.getElementById("touchNotice");
    
    // Set initial volume to 50%
    bgMusic.volume = 0.5;
    
    // Hide touch notice initially
    touchNotice.style.display = "none";

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resize);
    resize();

    function goFullScreenAndLock() {
      const el = document.documentElement;
      const promise =
        el.requestFullscreen?.() ||
        el.webkitRequestFullscreen?.() ||
        el.msRequestFullscreen?.();

      if (promise) {
        promise.then(() => {
          if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock("landscape").catch(err => {
              console.warn("Orientation lock failed:", err);
            });
          }
        }).catch(err => {
          console.warn("Fullscreen request failed:", err);
        });
      }
    }

    function checkOrientation() {
      const isPortrait = window.innerHeight > window.innerWidth;
      rotateNotice.style.display = isPortrait ? "flex" : "none";
      
      // Auto-start in landscape if in WebView APK
      if (!isPortrait && isWebViewAPK() && !gameRunning) {
        setTimeout(startGame, 500);
      }
    }

    // Detect if we're in a WebView APK environment
    function isWebViewAPK() {
      const userAgent = navigator.userAgent.toLowerCase();
      // Check for Android WebView or iOS UIWebView/WKWebView
      return (userAgent.includes('wv') || 
             (userAgent.includes('android') && !userAgent.includes('chrome')) || 
             (userAgent.includes('iphone') && userAgent.includes('safari') && !userAgent.includes('chrome')));
    }

    window.addEventListener("orientationchange", checkOrientation);
    window.addEventListener("resize", checkOrientation);

    let gameRunning = false,
        lastTime = 0,
        score = 0,
        gameSpeed = 1,
        obstacles = [],
        obstacleTimer = 0;

    const player = {
      x: 50, y: 0,
      width: 50, height: 50,
      velocityY: 0,
      jumpForce: 15,
      gravity: 0.7,
      grounded: false
    };

    const clouds = [];
    const cloudCount = 8;
    for (let i = 0; i < cloudCount; i++) {
      clouds.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height * 0.5,
        scale: 0.5 + Math.random() * 0.8
      });
    }

    function startGame() {
      if (gameRunning) return;
      
      // Auto-rotate on mobile
      if (isMobile()) {
        goFullScreenAndLock();
      }
      
      gameRunning = true;
      lastTime = 0;
      score = 0;
      gameSpeed = 1;
      obstacles = [];
      obstacleTimer = 0;
      player.y = canvas.height - 150;
      player.velocityY = 0;
      player.grounded = false;

      // Show touch notice on mobile
      touchNotice.style.display = isMobile() ? "block" : "none";

      // Start background music
      bgMusic.currentTime = 0;
      bgMusic.play().catch(e => {
        console.log("Autoplay blocked, user interaction required");
      });

      startOverlay.classList.add("hidden");

      requestAnimationFrame(gameLoop);
    }
    
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    function gameLoop(ts) {
      if (!gameRunning) return;
      if (!lastTime) lastTime = ts;
      const delta = ts - lastTime;
      lastTime = ts;

      gameSpeed += delta * 0.00005;
      score += gameSpeed * delta * 0.01;
      
      // Update UI stats
      scoreDisplay.textContent = `Score: ${Math.floor(score)}`;
      speedDisplay.textContent = `Speed: ${gameSpeed.toFixed(2)}`;

      // Sky gradient
      const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
      grad.addColorStop(0, "#87CEEB");
      grad.addColorStop(1, "#b0e0e6");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw clouds
      clouds.forEach(c => {
        c.x -= 0.3 * gameSpeed;
        if (c.x < -200 * c.scale) {
          c.x = canvas.width + 50;
          c.y = Math.random() * canvas.height * 0.5;
        }
        ctx.fillStyle = "rgba(255,255,255,0.8)";
        ctx.beginPath();
        const cw = 150 * c.scale, ch = 60 * c.scale;
        ctx.ellipse(c.x, c.y, cw, ch, 0, 0, 2 * Math.PI);
        ctx.ellipse(c.x - cw * 0.6, c.y + ch * 0.1, cw * 0.7, ch * 0.7, 0, 0, 2 * Math.PI);
        ctx.ellipse(c.x + cw * 0.6, c.y + ch * 0.1, cw * 0.7, ch * 0.7, 0, 0, 2 * Math.PI);
        ctx.fill();
      });

      // Player physics
      player.velocityY += player.gravity;
      player.y += player.velocityY;
      if (player.y + player.height > canvas.height - 100) {
        player.y = canvas.height - 100 - player.height;
        player.velocityY = 0;
        player.grounded = true;
      } else {
        player.grounded = false;
      }

      // Ground
      ctx.fillStyle = "#654321";
      ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
      
      // Draw grass on top of ground
      ctx.fillStyle = "#2a8a5c";
      ctx.fillRect(0, canvas.height - 100, canvas.width, 10);

      // Player character
      ctx.fillStyle = "#ff0000";
      ctx.fillRect(player.x, player.y, player.width, player.height);
      
      // Player details
      ctx.fillStyle = "#333";
      ctx.fillRect(player.x + 10, player.y + 10, 15, 15); // eye
      ctx.fillRect(player.x + 25, player.y + 30, 20, 10); // mouth

      // Generate obstacles
      obstacleTimer += delta;
      if (obstacleTimer > 1500) {
        const h = 40 + Math.random() * 30;
        obstacles.push({
          x: canvas.width,
          y: canvas.height - 100 - h,
          width: 20 + Math.random() * 30,
          height: h
        });
        obstacleTimer = 0;
      }

      // Process obstacles
      for (let i = obstacles.length - 1; i >= 0; i--) {
        const o = obstacles[i];
        o.x -= 6 * gameSpeed;
        
        // Collision detection
        if (player.x < o.x + o.width &&
            player.x + player.width > o.x &&
            player.y < o.y + o.height &&
            player.y + player.height > o.y) {
          return gameOver();
        }
        
        // Remove if off screen
        if (o.x + o.width < 0) {
          obstacles.splice(i, 1);
        } else {
          // Draw obstacle
          ctx.fillStyle = "#8B4513";
          ctx.fillRect(o.x, o.y, o.width, o.height);
          
          // Draw obstacle top
          ctx.fillStyle = "#5d2900";
          ctx.fillRect(o.x, o.y, o.width, 10);
        }
      }

      requestAnimationFrame(gameLoop);
    }

    // Jump function
    function jump() {
      if (player.grounded) {
        player.velocityY = -player.jumpForce;
        player.grounded = false;
        
        // Add jump effect
        ctx.fillStyle = "rgba(15, 204, 69, 0.3)";
        ctx.beginPath();
        ctx.arc(player.x + player.width/2, player.y + player.height, 30, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // Full-screen touch control
    canvas.addEventListener("touchstart", function(e) {
      e.preventDefault();
      
      // Check if touch is on UI elements
      const rect = canvas.getBoundingClientRect();
      const touchX = e.touches[0].clientX - rect.left;
      const touchY = e.touches[0].clientY - rect.top;
      
      // Define safe zones where touch doesn't trigger jump
      const isInVolumeControl = touchX > canvas.width - 100 && touchY < 100;
      const isInStatsArea = touchX < 200 && touchY < 100;
      
      if (!isInVolumeControl && !isInStatsArea) {
        jump();
      }
    }, { passive: false });

    // Full-screen click control for desktop
    canvas.addEventListener("click", function(e) {
      const rect = canvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;
      
      // Define safe zones where click doesn't trigger jump
      const isInVolumeControl = clickX > canvas.width - 100 && clickY < 100;
      const isInStatsArea = clickX < 200 && clickY < 100;
      
      if (!isInVolumeControl && !isInStatsArea) {
        jump();
      }
    });

    // Button controls
    jumpBtn.addEventListener("touchstart", e => {
      e.preventDefault();
      jump();
    }, { passive: false });
    
    jumpBtn.addEventListener("mousedown", e => {
      jump();
    });

    // Volume controls
    volDownBtn.addEventListener("click", () => {
      if (bgMusic.volume > 0.1) {
        bgMusic.volume -= 0.1;
      } else {
        bgMusic.volume = 0;
      }
    });
    
    volUpBtn.addEventListener("click", () => {
      if (bgMusic.volume < 0.9) {
        bgMusic.volume += 0.1;
      } else {
        bgMusic.volume = 1;
      }
    });

    function gameOver() {
      gameRunning = false;
      
      // Hide touch notice
      touchNotice.style.display = "none";
      
      // Stop background music
      bgMusic.pause();

      // Show game over overlay
      ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      ctx.fillStyle = "#fff";
      ctx.font = "bold 48px sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2 - 40);
      
      ctx.font = "36px sans-serif";
      ctx.fillText(`Score: ${Math.floor(score)}`, canvas.width / 2, canvas.height / 2 + 20);
      
      ctx.font = "24px sans-serif";
      ctx.fillText("Tap anywhere to restart", canvas.width / 2, canvas.height / 2 + 80);
      
      // Set up restart
      canvas.addEventListener("click", restartGame);
      canvas.addEventListener("touchstart", restartGame);
    }
    
    function restartGame(e) {
      // Prevent restart if touch is on UI elements
      const rect = canvas.getBoundingClientRect();
      let touchX, touchY;
      
      if (e.type === "touchstart") {
        touchX = e.touches[0].clientX - rect.left;
        touchY = e.touches[0].clientY - rect.top;
      } else {
        touchX = e.clientX - rect.left;
        touchY = e.clientY - rect.top;
      }
      
      // Define safe zones where touch doesn't trigger restart
      const isInVolumeControl = touchX > canvas.width - 100 && touchY < 100;
      const isInStatsArea = touchX < 200 && touchY < 100;
      
      if (!isInVolumeControl && !isInStatsArea) {
        canvas.removeEventListener("click", restartGame);
        canvas.removeEventListener("touchstart", restartGame);
        startGame();
      }
    }

    // Initial setup
    checkOrientation();
    
    // Auto-start if in WebView APK and in landscape
    if (isWebViewAPK()) {
      const isPortrait = window.innerHeight > window.innerWidth;
      if (!isPortrait) {
        setTimeout(startGame, 1000);
      }
    }
  </script>
</body>
</html>